---
layout: post
read_time: true
show_date: true
title: "web新技术"
date: 2021-04-20 12:32:20 -0600
img: posts/20210420/nnet_optimization.jpg
tags: [PWA, Docker, WSAM, K8s, RPC, HTTP2]
author: Armando Maynez
description: "some new tech"
toc: yes
---
## PWA
progressive web app。 既能在新浏览器上使用，体验如原生app，又可以兼容旧浏览器。技术集合：Web Push、Service Worker、App Manifest。 消息推送/文件缓存/主屏幕图标
Service workers ：让 PWA 离线工作。更新使用具体的库，

多种worker对比：
webworker：计算比较重的任务，避免长时间占用主线程。
serviceworker：文件缓存
Worklets： 改变浏览器渲染线程

### window.caches
缓存接口，资源。目前用于pwa
const cacheName = 'userSettings';
  const url = '/api/user';
  window.caches.open(cacheName).then((cache) => {
    cache.add(url).then((data) => {
      console.log('Data cached ');
      console.log(data);
    });
  });
  window.caches.open(cacheName).then((cache) => {
    cache.match(url).then(async (settings) => {
      console.log(await settings?.json());
    });
  });





## WebAssembly/wsam
二进制代码执行
Media Source Extensions：
音视频编解码，h5播放器，波形图

## Docker ：
虚拟化，对比VMware ，轻量，但隔离性差点; 容器，镜像，仓库; 单机部署;方便移植。
### pm2 vs docker
同样作为进程管理，都能自动重启，负载均衡，
pm2 有自动重启，最大重启次数，重启间隔；负载均衡用cluster模块
docker： docker操作系统级别的，较为健壮。负载均衡算法不同
nginx：除了专业做负载均衡，还做ssl解密，静态文件解析？


## K8s：
容器编排。多机集群，可以用来做调度负载。用apisever 模块，做对外接口。controller  等

## rpc
起始于微服务架构下。原来的大服务拆分成小服务，分布式部署。小服务之间的需要频繁调用， 又想跟大服务调用一样，直接调用，所以产生了rpc （远程过程调用）。因为在不同机器上，所以需要寻址，序列化/反序列化成二进制，tcp传输等。
// Client端
// int l_times_r = Call(ServerAddr, Multiply, lvalue, rvalue)
1. 将这个调用映射为Call ID。这里假设用最简单的字符串当Call ID的方法
2. 将Call ID，lvalue和rvalue序列化。可以直接将它们的值以二进制形式打包
3. 把2中得到的数据包发送给ServerAddr，这需要使用网络传输层
4. 等待服务器返回结果
5. 如果服务器调用成功，那么就将结果反序列化，并赋给l_times_r

// Server端
1. 在本地维护一个Call ID到函数指针的映射call_id_map
2. 等待请求
3. 得到一个请求后，将其数据包反序列化，得到Call ID
4. 通过在call_id_map中查找，得到相应的函数指针
5. 将lvalue和rvalue反序列化后，在本地调用Multiply函数，得到结果
6. 将结果序列化后通过网络返回给Client



## http2：
二进制分帧，必须支持https；
多路复用：同一个tcp链接全双工通信；可无序发送，有标识来进行组装，可以有优先级；
头部压缩：第一次请求的头部，第二次不会再发送，包的体积就较小
服务器推送：服务器可以主动对html中的js css主动推送，不用等到浏览器解析后相应位置再请求，客户端也有拒绝推送的权利，例如本地已经有缓存，浏览器可以通过发送RST_STREAM帧来拒收。

## rpc vs http？
为什么不用http？
http协议封装时 会带很多无用的信息，导致包的提交较大。但通用性好，适用于外部api。
rpc一般用于公司内部服务调用，可以自行约定格式，体积小，效率高。
普通话和黑话的区别：普通话标准通用；黑话精简私密可定制，但是需要客户端、服务端都懂

## http vs http2 https
http: 文本传输；数据不加密；request-response，多个请求需要多个tcp链接，请求包较大
http1.0 ：一个http请求对应一个tcp链接。
http1.1: keepalive，多个http请求复用同一个tcp链接，这样可以节约连接建立的时间。但是同个tcp链接，同一时间只能一个http请求。因为文本类型的，无法标识响应是哪个请求的，所以只能是顺序发送。
总结：因为同个tcp链接同一时间只能发送一个请求，所以想要并发多个请求，还是需要建立多个tcp链接。但是浏览器会对tcp总数有限制。
什么时候会断开tcp连接？
1. 客户端主动要求断开，connection:close
2. 客户端异常时，服务器端有心跳机制，例如15s，收不到客户端回应时，主动断开。

https： http over ssl 使用ssl/tls对数据加密。无论是请求头还是数据都可以加密。